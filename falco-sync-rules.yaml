- rule: Detect whoami Command
  desc: Trigger alert when 'whoami' is run
  condition: evt.type = execve and proc.name = "whoami"
  output: "ALERT: whoami command run by user=%user.name (parent=%proc.pname)"
  priority: NOTICE
  tags: [custom, test]

- rule: Port 8080 Opened
  desc: Detect when a process begins listening on TCP port 8080
  condition: evt.type = listen and fd.sport = 8080 and fd.l4proto = tcp and fd.typechar = 4
  output: "✅ Port 8080 opened by %proc.name (pid=%proc.pid user=%user.name)"
  priority: NOTICE
  tags: [lab, selfscore, openport]

- rule: Learner Probed Port 8080
  desc: Detect when the user tries to check if port 8080 is open
  condition: evt.type = execve and proc.name in (nmap, curl, ss) and proc.args contains "8080"
  output: "🕵️ Learner probed port 8080 using %proc.name (cmd=%proc.cmdline user=%user.name)"
  priority: INFO
  tags: [lab, selfscore, portscan, verify]

- rule: Detect Netcat Listener
  desc: Detect when a user starts a netcat listener on any TCP port
  condition: evt.type = bind and proc.name = "nc"
  output: "📡 Netcat listener detected: proc=%proc.name user=%user.name port=%fd.sport"
  priority: WARNING
  tags: [lab, selfscore, netcat, listener]

- rule: Detect Use of ifconfig
  desc: Detect when a user runs the ifconfig command (legacy network tool)
  condition: evt.type = execve and proc.name = "ifconfig"
  output: "🌐 ifconfig command detected (cmd=%proc.cmdline user=%user.name)"
  priority: INFO
  tags: [network, selfscore, open]

- rule: Detect Netstat Command
  desc: Detect when a user runs the netstat command (network diagnostics)
  condition: evt.type = execve and proc.name = "netstat"
  output: "📡 Netstat executed: %proc.cmdline by %user.name"
  priority: INFO
  tags: [lab, selfscore, net, netstat]

- rule: Detect cat on /etc/passwd
  desc: Detect when a user runs `cat` to read the /etc/passwd file
  condition: >
    evt.type in (open, openat) and
    fd.name = "/etc/passwd" and
    proc.name = "cat"
  output: "🔐 /etc/passwd read via cat by user=%user.name (cmd=%proc.cmdline)"
  priority: NOTICE
  tags: [lab, selfscore, passwd, recon]

- rule: Detect iptables Modification
  desc: Detect when a user attempts to add or modify firewall rules using iptables
  condition: >
    evt.type = execve and
    proc.name = "iptables" and
    proc.args contains "-A"
  output: "🛡️ iptables modification detected: %proc.cmdline by user=%user.name"
  priority: WARNING
  tags: [lab, selfscore, firewall, iptables]

# === DCWF Competency 641 Rules ===

- rule: Enable Logging System
  desc: Detect when a user enables a system logging mechanism
  condition: >
    evt.type = execve and
    proc.name in ("auditctl", "ufw") and
    (proc.args contains "-e" or proc.args contains "logging" or proc.args contains "start")
  output: "🛡️ Logging enabled: %proc.name %proc.args by %user.name"
  priority: NOTICE
  tags: [competency:641, logging, configuration]

- rule: Modify Logging Configuration
  desc: Detect edits to common logging config files
  condition: >
    (evt.type in (open, openat) and
     fd.name in ("/etc/audit/audit.rules", "/etc/rsyslog.conf", "/etc/ufw/ufw.conf")) and
    proc.name in ("nano", "vi", "vim", "sed", "echo")
  output: "⚙️ Logging config modified: %fd.name by %user.name using %proc.name"
  priority: WARNING
  tags: [competency:641, logging, config-edit]

- rule: Trigger Security Logging
  desc: Detect common security-relevant system probes that should be logged
  condition: >
    (proc.name = "nmap" and proc.args contains "-p") or
    (proc.name = "nc" and proc.args contains "-z")
  output: "🔍 Security-relevant action executed: %proc.name %proc.args by %user.name"
  priority: INFO
  tags: [competency:641, log-trigger, testing]
